#                                        5816,5904,7423,7679,
#                                       7981,8536,8537,8691,
#                                      9265,9685,9700,9715,
#                                     9716,9721,11025,11212,
#                                    11213,11417,11418,11419,
#                                   12879,12909,12912,13145,
#                                  13182,13774,13775,13784,
#                                 13827,14155,15234,15235,15892,
#                                15901,16518,16531,16533,16536) ~ FALSE,
#                TRUE ~ TRUE))%>%
filter(to_keep1) %>% select(-c( to_keep1,rowname)) %>%
#filter(to_keep2) %>% select(-c( to_keep2,rowname)) %>%
rename("dt_max_yield_mm" = "dt")
hobo_events5 <- hobo_events2 %>%
left_join(., hobo_events4 %>% select(1:3),
by = c("site", "Event")) %>%
group_by(site, Event) %>%
mutate(limb = case_when(datetime_EST2 < dt_max_yield_mm ~ "rising",
datetime_EST2 > dt_max_yield_mm ~ "falling",
datetime_EST2== dt_max_yield_mm ~ "peak")) %>%
select(-dt_max_yield_mm)
View(hobo_events2)
View(hobo_events4)
hobo_events5 <- hobo_events2 %>%
left_join(., hobo_events4 %>% select(1:5),
by = c("site", "hobo_event_n")) %>%
group_by(site, Event) %>%
mutate(limb = case_when(datetime_EST2 < dt_max_yield_mm ~ "rising",
datetime_EST2 > dt_max_yield_mm ~ "falling",
datetime_EST2== dt_max_yield_mm ~ "peak")) %>%
select(-dt_max_yield_mm)
hobo_events5 <- hobo_events2 %>%
left_join(., hobo_events4 %>% select(1:5),
by = c("site", "hobo_event_n")) %>%
group_by(site, Event) %>%
mutate(limb = case_when(dt < dt_max_yield_mm ~ "rising",
dt > dt_max_yield_mm ~ "falling",
dt== dt_max_yield_mm ~ "peak")) %>%
select(-dt_max_yield_mm)
hobo_events5 <- hobo_events2 %>%
left_join(., hobo_events4,
by = c("site", "hobo_event_n")) %>%
group_by(site, hobo_event_n) %>%
mutate(limb = case_when(dt < dt_max_yield_mm ~ "rising",
dt > dt_max_yield_mm ~ "falling",
dt== dt_max_yield_mm ~ "peak")) %>%
select(-dt_max_yield_mm)
hobo_events5 <- hobo_events2 %>%
left_join(., hobo_events4,
by = c( "hobo_event_n")) %>%
group_by(site, hobo_event_n) %>%
mutate(limb = case_when(dt < dt_max_yield_mm ~ "rising",
dt > dt_max_yield_mm ~ "falling",
dt== dt_max_yield_mm ~ "peak")) %>%
select(-dt_max_yield_mm)
View(hobo_events2)
View(hobo_events5)
library(here)
here <- here()
here
library(tidyverse)
library(lubridate)
library(dygraphs)
library(xts)
hobo_events <- readRDS(paste0(here, "/output/hobo_events.Rds"))
hobo_events2 <- hobo_events%>%
pivot_longer(cols = contains("_mm"), names_to = "site",
values_to = "yield_mm")%>%
group_by(site, dt) %>%
arrange(dt)%>%
ungroup()%>%
select(dt, site,  yield_mm, hobo_event_n)%>%
drop_na()
#Calculate event statistics
hobo_max <- hobo_events2 %>%
group_by(site, hobo_event_n) %>%
arrange(dt)%>%
dplyr::summarise(max_yld_mm = max(yield_mm, na.rm=T))
#Join the max rate with the time series to access the time of max for each event
hobo_events3 <- inner_join(hobo_max, hobo_events2,
by = c("site", "hobo_event_n")) %>%
rownames_to_column()
#manually keep the max yield rows and remove the duplicates
hobo_events4 <- hobo_events3 %>%
mutate(to_keep1 = case_when(yield_mm < max_yld_mm ~ FALSE,
TRUE ~ TRUE )) %>%
#mutate(to_keep2 = case_when (rowname %in% c(51,55,220,234,267,
#                                           1848,1859,1907,2746,
#                                         2990,4203,4207,4210,
#                                         5408,5574,5672,5674,
#                                        5816,5904,7423,7679,
#                                       7981,8536,8537,8691,
#                                      9265,9685,9700,9715,
#                                     9716,9721,11025,11212,
#                                    11213,11417,11418,11419,
#                                   12879,12909,12912,13145,
#                                  13182,13774,13775,13784,
#                                 13827,14155,15234,15235,15892,
#                                15901,16518,16531,16533,16536) ~ FALSE,
#                TRUE ~ TRUE))%>%
filter(to_keep1) %>% select(-c( to_keep1,rowname)) %>%
#filter(to_keep2) %>% select(-c( to_keep2,rowname)) %>%
rename("dt_max_yield_mm" = "dt")
hobo_events5 <- hobo_events2 %>%
left_join(., hobo_events4,
by = c("site", "hobo_event_n")) %>%
group_by(site, hobo_event_n) %>%
mutate(limb = case_when(dt < dt_max_yield_mm ~ "rising",
dt > dt_max_yield_mm ~ "falling",
dt== dt_max_yield_mm ~ "peak")) %>%
select(-dt_max_yield_mm)
View(hobo_events5)
hobo_events6 <- hobo_events5%>%
filter(limb == "falling") %>%
group_by(hobo_event_n,site)%>%
mutate(time =  seconds((dt - dt_max_yield_mm)*60))
hobo_events5 <- hobo_events2 %>%
left_join(., hobo_events4,
by = c("site", "hobo_event_n")) %>%
group_by(site, hobo_event_n) %>%
mutate(limb = case_when(dt < dt_max_yield_mm ~ "rising",
dt > dt_max_yield_mm ~ "falling",
hobo_events5 <- hobo_events2 %>%
left_join(., hobo_events4,
by = c("site", "hobo_event_n")) %>%
group_by(site, hobo_event_n) %>%
mutate(limb = case_when(dt < dt_max_yield_mm ~ "rising",
dt > dt_max_yield_mm ~ "falling",
dt== dt_max_yield_mm ~ "peak"))
View(hobo_events5)
View(hobo_events5)
hobo_events6 <- hobo_events5%>%
filter(limb == "falling") %>%
group_by(hobo_event_n,site)%>%
mutate(time =  seconds((dt - dt_max_yield_mm)*60))
View(hobo_events5)
#manually keep the max yield rows and remove the duplicates
hobo_events4 <- hobo_events3 %>%
mutate(to_keep1 = case_when(yield_mm < max_yld_mm ~ FALSE,
TRUE ~ TRUE )) %>%
#mutate(to_keep2 = case_when (rowname %in% c(51,55,220,234,267,
#                                           1848,1859,1907,2746,
#                                         2990,4203,4207,4210,
#                                         5408,5574,5672,5674,
#                                        5816,5904,7423,7679,
#                                       7981,8536,8537,8691,
#                                      9265,9685,9700,9715,
#                                     9716,9721,11025,11212,
#                                    11213,11417,11418,11419,
#                                   12879,12909,12912,13145,
#                                  13182,13774,13775,13784,
#                                 13827,14155,15234,15235,15892,
#                                15901,16518,16531,16533,16536) ~ FALSE,
#                TRUE ~ TRUE))%>%
filter(to_keep1) %>% select(-c( to_keep1,rowname)) %>%
#filter(to_keep2) %>% select(-c( to_keep2,rowname)) %>%
rename("dt_max_yield_mm" = "dt")
hobo_events5 <- hobo_events2 %>%
left_join(., hobo_events4,
by = c("site", "hobo_event_n")) %>%
group_by(site, hobo_event_n) %>%
mutate(limb = case_when(dt < dt_max_yield_mm ~ "rising",
dt > dt_max_yield_mm ~ "falling",
dt== dt_max_yield_mm ~ "peak"))
View(hobo_events5)
hobo_events6 <- hobo_events5%>%
filter(limb == "falling") %>%
group_by(hobo_event_n,site)%>%
mutate(time =  seconds((dt - dt_max_yield_mm)*60))
View(hobo_events6)
ggplot(hobo_events5, aes(x = dt, y = yield_mm, color = site) ) +
geom_smooth(se = FALSE, method = "loess", span = 0.1) +
scale_x_continuous( breaks = seq(
2018-07-24, 2018-11-03, by = 0.01) ) +
theme_bw() + facet_wrap(~site, scales = "free_y", ncol = 1)+
theme(legend.position="none")
View(hobo_events6)
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
nest()
View(mod_lin)
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site)
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
nest()
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
nest() %>%
mutate(nobs = map_dbl(hobo_events6, ~nrow(.x)))
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
nest() %>%
# mutate(nobs = map_dbl(hobo_events6, ~nrow(.x))) %>%
mutate(r = map_dbl(y = .x$log, x= .x$yield_mm.x),
p = map_dbl(y= .x$log, x = .x$max_yld_mm))
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
nest() %>%
# mutate(nobs = map_dbl(hobo_events6, ~nrow(.x))) %>%
mutate(r = map_dbl(hobo_events6, y = .x$log, x= .x$yield_mm.x),
p = map_dbl(hobo_events6, y= .x$log, x = .x$max_yld_mm))
library(here)
here <- here()
here
library(tidyverse)
library(lubridate)
library(dygraphs)
library(xts)
hobo_events <- readRDS(paste0(here, "/output/hobo_events.Rds"))
hobo_events2 <- hobo_events%>%
pivot_longer(cols = contains("_mm"), names_to = "site",
values_to = "yield_mm")%>%
group_by(site, dt) %>%
arrange(dt)%>%
ungroup()%>%
select(dt, site,  yield_mm, hobo_event_n)%>%
drop_na()
#Calculate event statistics
hobo_max <- hobo_events2 %>%
group_by(site, hobo_event_n) %>%
arrange(dt)%>%
dplyr::summarise(max_yld_mm = max(yield_mm, na.rm=T))
#Join the max rate with the time series to access the time of max for each event
hobo_events3 <- inner_join(hobo_max, hobo_events2,
by = c("site", "hobo_event_n")) %>%
rownames_to_column()
#manually keep the max yield rows and remove the duplicates
hobo_events4 <- hobo_events3 %>%
mutate(to_keep1 = case_when(yield_mm < max_yld_mm ~ FALSE,
TRUE ~ TRUE )) %>%
#mutate(to_keep2 = case_when (rowname %in% c(51,55,220,234,267,
#                                           1848,1859,1907,2746,
#                                         2990,4203,4207,4210,
#                                         5408,5574,5672,5674,
#                                        5816,5904,7423,7679,
#                                       7981,8536,8537,8691,
#                                      9265,9685,9700,9715,
#                                     9716,9721,11025,11212,
#                                    11213,11417,11418,11419,
#                                   12879,12909,12912,13145,
#                                  13182,13774,13775,13784,
#                                 13827,14155,15234,15235,15892,
#                                15901,16518,16531,16533,16536) ~ FALSE,
#                TRUE ~ TRUE))%>%
filter(to_keep1) %>% select(-c( to_keep1,rowname)) %>%
#filter(to_keep2) %>% select(-c( to_keep2,rowname)) %>%
rename("dt_max_yield_mm" = "dt")
hobo_events5 <- hobo_events2 %>%
left_join(., hobo_events4,
by = c("site", "hobo_event_n")) %>%
group_by(site, hobo_event_n) %>%
mutate(limb = case_when(dt < dt_max_yield_mm ~ "rising",
dt > dt_max_yield_mm ~ "falling",
dt== dt_max_yield_mm ~ "peak"))
hobo_events6 <- hobo_events5%>%
filter(limb == "falling") %>%
group_by(hobo_event_n,site)%>%
mutate(time =  seconds((dt - dt_max_yield_mm)*60))
View(hobo_events6)
gfgModel <- lm(log(yield_mm.x) ~ -k * time + log(max_yld_mm))
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
nest() %>%
gfgModel <- lm(log(yield_mm.x) ~ -k * time + log(max_yld_mm))
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
nest()
View(mod_lin)
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
# nest() %>%
gfgModel <- lm(log(yield_mm.x) ~ -k * time + log(max_yld_mm))
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site)
View(mod_lin)
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
# nest() %>%
gfgModel <- lm(log(yield_mm.x) ~ -k * time + log(max_yld_mm))
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(gfgModel <- lm(log(yield_mm.x) ~ -k * time + log(max_yld_mm)))
mod_lin <- hobo_events6
mod_lin <- hobo_events6 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(gfgModel <- lm(log(yield_mm.x) ~ -k * time + log(max_yld_mm)))
View(mod_lin)
gfgModel <- lm(log(hobo_events6$yield_mm.x) ~ -k * time + log(hobo_events6$max_yld_mm))
(log(hobo_events6$max_yld_mm) - log(hobo_events6$yield_mm.x))/hobo_events6$time =  k
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
# nest() %>%
mutate((log(hobo_events6$max_yld_mm) - log(hobo_events6$yield_mm.x))/hobo_events6$time =  k )
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(k <- (log(hobo_events6$max_yld_mm) - log(hobo_events6$yield_mm.x))/hobo_events6$time )
mutate(k <- (log(hobo_events6$max_yld_mm) - log(hobo_events6$yield_mm.x))/as.numeric(hobo_events6$time ))
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(k <- (log(hobo_events6$max_yld_mm) - log(hobo_events6$yield_mm.x))/as.numeric(hobo_events6$time, na.rm ))
mod_lin <- hobo_events6 %>%
group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a <- log(max_yld_mm))%>%
mutate(b <-log(yield_mm.x))
mod_lin <- hobo_events6
mod_lin <- hobo_events6 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a <- log(max_yld_mm))
mod_lin <- hobo_events6 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
# mutate(a <- log(max_yld_mm))%>%
# mutate(b <-log(yield_mm.x))%>%
mutate(t <- time_length(time, unit = "seconds"))
View(hobo_max)
View(mod_lin)
mod_lin <- hobo_events6 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a <- max_yld_mm)%>%
mutate(b <- yield_mm.x)%>%
mutate(t <- time_length(time, unit = "seconds"))
View(mod_lin)
mod_lin <- hobo_events6 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a <- max_yld_mm)%>%
mutate(b <- yield_mm.x)%>%
mutate(t <- time_length(time, unit = "seconds")) %>%
mutate(c <- log(a) - log(b))
mod_lin <- hobo_events6 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a <- max_yld_mm)%>%
mutate(b <- yield_mm.x)%>%
mutate(t <- time_length(time, unit = "seconds")) %>%
select(a,b.t)
mod_lin <- hobo_events6 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a <- max_yld_mm)%>%
mutate(b <- yield_mm.x)%>%
mutate(t <- time_length(time, unit = "seconds")) %>%
select(a,b.t) %>%
mutate(c <- log(a) - log(b))
View(mod_lin)
mod_lin <- hobo_events6 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a <- max_yld_mm)%>%
mutate(b <- yield_mm.x)%>%
mutate(t <- time_length(time, unit = "seconds")) %>%
mutate(c <- log(max_yld_mm) - log(yield_mm.x))
mod_lin <- hobo_events6 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a <- max_yld_mm)%>%
mutate(b <- yield_mm.x)%>%
mutate(t <- time_length(time, unit = "seconds")) %>%
mutate(c <- ln(max_yld_mm) - ln(yield_mm.x))
View(hobo_events6)
hobo_events7 <- hobo_events6 %>%
mutate(yield_mm_clean = case_when(yield_mm.x < 0 |
is.na(yield_mm.x) ~ 0,
TRUE ~ yield_mm.x)) %>%
ungroup() %>%
select(dt, site, hobo_event_n, yield_mm, rate_mm_5min_clean) %>%
rename("yield_mm" = "yield_mm_clean")
hobo_events7 <- hobo_events6 %>%
mutate(yield_mm_clean = case_when(yield_mm.x < 0 |
is.na(yield_mm.x) ~ 0,
TRUE ~ yield_mm.x)) %>%
ungroup()
hobo_events7 <- hobo_events6 %>%
mutate(yield_mm_clean = case_when(yield_mm.x < 0 |
is.na(yield_mm.x) ~ 0,
TRUE ~ yield_mm.x)) %>%
ungroup() %>%
select(dt, site, hobo_event_n, yield_mm_clean) %>%
rename("yield_mm" = "yield_mm_clean")
View(hobo_events7)
hobo_events7 <- hobo_events6 %>%
mutate(yield_mm_clean = case_when(yield_mm.x < 0 |
is.na(yield_mm.x) ~ 0,
TRUE ~ yield_mm.x)) %>%
ungroup() %>%
select(dt, site, hobo_event_n, yield_mm_clean, dt_max_yield_mm,max_yld_mm, time, limb) %>%
rename("yield_mm" = "yield_mm_clean")
View(hobo_events7)
View(hobo_events6)
mod_lin <- hobo_events7 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a <- max_yld_mm)
View(mod_lin)
mod_lin <- hobo_events7 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a = max_yld_mm)
View(mod_lin)
mod_lin <- hobo_events7 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a = max_yld_mm)%>%
mutate(b = yield_mm)
mod_lin <- hobo_events7 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a = max_yld_mm)%>%
mutate(b = yield_mm)%>%
mutate(t = time_length(time, unit = "seconds"))
View(mod_lin)
mod_lin <- hobo_events7 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a = max_yld_mm)%>%
mutate(b = yield_mm)%>%
mutate(t = time_length(time, unit = "seconds")) %>%
mutate(c = log(a) - log(b))
View(mod_lin)
mod_lin <- hobo_events7 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a = max_yld_mm)%>%
mutate(b = yield_mm)%>%
mutate(t = time_length(time, unit = "seconds")) %>%
mutate(c = log(a) - log(b)) %>%
mutate(k = c/t)
View(mod_lin)
mod_lin <- hobo_events7 %>%
group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a = max_yld_mm)%>%
mutate(b = yield_mm)%>%
mutate(t = time_length(time, unit = "seconds")) %>%
mutate(c = log(a) - log(b)) %>%
mutate(k = c/t)
mod_lin <- hobo_events7 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a = max_yld_mm)%>%
mutate(b = yield_mm)%>%
mutate(t = time_length(time, unit = "seconds")) %>%
mutate(c = log(a) - log(b)) %>%
mutate(k = c/t)
mod_lin <- hobo_events7 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a = max_yld_mm)%>%
mutate(b = yield_mm)%>%
mutate(t = time_length(time, unit = "seconds")) %>%
mutate(c = log(a) - log(b)) %>%
mutate(k = c/t) %>%
mutate( to_keep = case_when( log(a) == log(b) ~ FALSE,
TRUE ~ TRUE ))%>%
filter(to_keep) %>% select(-c( to_keep))
View(mod_lin)
mod_lin <- hobo_events7 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a = max_yld_mm)%>%
mutate(b = yield_mm)%>%
mutate(t = time_length(time, unit = "seconds")) %>%
mutate( to_keep = case_when( a == b) ~ FALSE,
TRUE ~ TRUE ) %>%
filter(to_keep) %>% select(-c( to_keep))
mod_lin <- hobo_events7 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a = max_yld_mm)%>%
mutate(b = yield_mm)%>%
mutate(t = time_length(time, unit = "seconds")) %>%
mutate( to_keep <- case_when( a == b) ~ FALSE,
TRUE ~ TRUE )
mod_lin <- hobo_events7 %>%
# group_by(hobo_event_n,site) %>%
# nest() %>%
mutate(a = max_yld_mm)%>%
mutate(b = yield_mm)%>%
mutate(t = time_length(time, unit = "seconds")) %>%
mutate( to_keep <- case_when( a == b) ~ FALSE,
TRUE ~ TRUE ) %>%
filter(to_keep) %>% select(-c( to_keep))%>%
mutate(c = log(a) - log(b)) %>%
mutate(k = c/t)
mod_lin <- hobo_events7 %>%
mutate(a = max_yld_mm)%>%
mutate(b = yield_mm)%>%
mutate(t = time_length(time, unit = "seconds")) %>%
# mutate( to_keep <- case_when( a == b) ~ FALSE,
#        TRUE ~ TRUE ) %>%
#filter(to_keep) %>% select(-c( to_keep))%>%
mutate(c = log(max_yld_mm) - log(yield_mm)) %>%
mutate(k = c/t)
View(mod_lin)
mod_lin <- hobo_events7 %>%
mutate(t = time_length(time, unit = "seconds")) %>%
mutate(c = log(max_yld_mm) - log(yield_mm)) %>%
mutate(k = c/t)
View(mod_lin)
mod_lin <- hobo_events7 %>%
mutate(t = time_length(time, unit = "seconds")) %>%
mutate(c = log(max_yld_mm) - log(yield_mm)) %>%
mutate(k = c/t)
View(mod_lin)
